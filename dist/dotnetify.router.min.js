!function(a){"function"==typeof define&&define.amd?define(["jquery","knockout","dotnetify","path"],a):"object"==typeof exports&&"object"==typeof module?(window.Path=require("path"),module.exports=a(require("jquery"),require("knockout"),require("dotnetify"))):a(jQuery,ko,dotnetify)}(function(a,b,c){c.router={version:"1.1.0",urlPath:document.location.pathname,init:function(){if("undefined"==typeof Path)throw new Error("Pathjs library is required for routing.");Path.history.listen(!0),Path.routes.rescue=function(){window.location.replace(document.location.pathname)}},mapTo:function(a,b){"undefined"!=typeof Path&&Path.map(a).to(function(){b(this.params)})},match:function(a){if("undefined"!=typeof Path){var b=Path.match(a,!0);if(null!=b)return b.run(),!0}return!1},overrideUrl:function(a){return a},pushState:function(a,b,d){c.router.urlPath="","undefined"!=typeof Path&&Path.history.pushState(a,b,d)},redirect:function(b){c.router.urlPath=b;var d=a("[data-vm]");for(j=0;j<d.length;j++){var e=c.widget(d[j]);if(null!=e&&e.VM.$router.routeUrl())return}window.location.replace(b)},$ready:function(){this.$router.initRouting()}},c.router.$inject=function(b){b.$router=function(b){var d=function(){return{trim:function(a){if("string"!=typeof a)return"";for(;a.indexOf("/",a.length-1)>=0;)a=a.substr(0,a.length-1);for(;0==a.indexOf("/");)a=a.substr(1,a.length-1);return a},equal:function(a,b){return null!=a&&null!=b&&a.toLowerCase()==b.toLowerCase()},startsWith:function(a,b){return a.toLowerCase().slice(0,b.length)==b.toLowerCase()},endsWith:function(a,b){return""==b||a.toLowerCase().slice(-b.length)==b.toLowerCase()}}}();return{initRoot:function(){var a=this;if(a.hasOwnProperty("RoutingState")&&"function"==typeof a.RoutingState.Root&&a.$router._absRoot!=a.RoutingState.Root()){var b=d.trim(a.$element.attr("data-vm-root"));""!=b&&(b="/"+b);var c=d.trim(a.RoutingState.Root());a.$router._absRoot=""!=c?b+"/"+c:b,a.RoutingState.Root(a.$router._absRoot)}}.bind(b),initRouting:function(){var b=this;if(b.hasOwnProperty("RoutingState")&&"function"==typeof b.RoutingState.Templates){var d=b.RoutingState.Templates();if(null!=d){c.router.$init||(c.router.init(),c.router.$init=!0),b.$router.initRoot(),a.each(d,function(a,d){var e=b.$router.toUrl(d.UrlPattern());c.debug&&console.log("router> map "+e+" to template id="+d.Id()),c.router.mapTo(e,function(a){c.router.urlPath="";var e=d.UrlPattern();for(param in a)e=e.replace(":"+param,a[param]);e=e.replace(/\(\/:([^)]+)\)/g,"").replace(/\(|\)/g,""),b.$router.routeTo(e,d)})});var e=b.$router.toUrl(b.RoutingState.Active());""==c.router.urlPath&&(c.router.urlPath=e),b.$router.routeUrl()}}}.bind(b),isActive:function(a){return!(null==a||!a.hasOwnProperty("Path")||"function"!=typeof a.Path)&&d.equal(a.Path(),this.RoutingState.Active())}.bind(b),loadView:function(b,e,f,g,h){var i=this;if(null==e||""==e)return void a(b).empty();var j=function(){i.hasOwnProperty("RoutingState")&&"function"==typeof i.RoutingState.Root&&a.each(a(this).find("[data-vm]"),function(b,c){var e=a(c).attr("data-vm-root");if(e=null!=e?"/"+d.trim(i.RoutingState.Root())+"/"+d.trim(e):i.RoutingState.Root(),a(c).attr("data-vm-root",e),null!=g&&!a.isEmptyObject(g)){var f=a(c).attr("data-vm-arg");f=null!=f?a.extend(g,a.parseJSON(f.replace(/'/g,'"'))):g,a(c).attr("data-vm-arg",JSON.stringify(f))}}),"function"==typeof h&&h.apply(this)};e=c.router.overrideUrl(e),i.$loadView(b,e,f,g,j)}.bind(b),manualRouteTo:function(a,b,c,d){var e={};e.Target=function(){return b},e.ViewUrl=function(){return c},e.JSModuleUrl=function(){return d},this.$router.routeTo(a,e,!0)}.bind(b),routeTo:function(b,e,f){var g=this;c.debug&&console.log("router> route '"+b+"' to template id="+e.Id());var h=a("#"+e.Target()+" [data-vm-arg]").attr("data-vm-arg");if(!(null!=h&&(h=a.parseJSON(h.replace(/'/g,'"')),"string"==typeof h["RoutingState.Origin"]&&d.equal(h["RoutingState.Origin"],b))||1!=f&&g.hasOwnProperty("onRouteEnter")&&0==g.onRouteEnter(b,e)))return 0==a("#"+e.Target()).length?c.router.redirect(g.$router.toUrl(b)):void g.$router.loadView("#"+e.Target(),e.ViewUrl(),e.JSModuleUrl(),{"RoutingState.Origin":b},function(){g.RoutingState.Active(b),1!=f&&g.hasOwnProperty("onRouteExit")&&g.onRouteExit(b,e)}.bind(g))}.bind(b),routeUrl:function(){var b=this;if(!b.hasOwnProperty("RoutingState")||"function"!=typeof b.RoutingState.Templates)return!1;var e=b.RoutingState.Root();if(null==e)return!1;var f=c.router.urlPath;if(c.debug&&console.log("router> routing "+f),d.equal(f,e)){var g=a.grep(b.RoutingState.Templates(),function(a){return""===a.UrlPattern()});return void(g.length>0&&b.$router.routeTo("",g[0]))}if(e+="/",d.startsWith(f,e)){var h=null,g=a.grep(b.$element.find("[data-vm-route]"),function(b){return d.startsWith(f,a(b).attr("href"))});if(g.length>0)for(i=0;i<g.length;i++)(null==h||a(h).attr("href").length<a(g[i]).attr("href").length)&&(h=g[i]);if(null!=h){var j=a(h).attr("data-vm-route"),k=b.$router.hasOwnProperty("pathToRoute")&&b.$router.pathToRoute.hasOwnProperty(j)?b.$router.pathToRoute[j].$template:null;if(null!=k)return d.equal(c.router.urlPath,b.$router.toUrl(j))&&(c.router.urlPath=""),d.equal(b.RoutingState.Active(),j)||b.$router.routeTo(j,k),!0}else if(c.router.match(f))return c.router.urlPath="",!0}return!1}.bind(b),toUrl:function(a){var b=d.trim(a);return"("!=b.charAt(0)&&""!=b&&(b="/"+b),this.hasOwnProperty("RoutingState")&&("function"===this.RoutingState.Root,!0)?this.RoutingState.Root()+b:a}.bind(b)}}(b)},c.plugins.router=c.router,b.bindingHandlers.vmRoute={update:function(d,e,f,g,h){var j=h.$root,k=b.unwrap(e());if(!k.hasOwnProperty("Path")||!k.hasOwnProperty("TemplateId"))throw new Error("invalid vmRoute data at "+d.outerHTML);j.$router.initRoot(),path=k.Path();var l=null;if(j.hasOwnProperty("RoutingState")&&"function"==typeof j.RoutingState.Templates&&null!=j.RoutingState.Templates()){var m=a.grep(j.RoutingState.Templates(),function(a){return a.Id()==k.TemplateId()});if(m.length>0)l=m[0],null==path&&(path=l.UrlPattern(),k.Path(path));else if(null==k.RedirectRoot())throw new Error("vmRoute cannot find route template '"+k.TemplateId()+"' at "+d.outerHTML)}if(null!=k.RedirectRoot()){var n=k.RedirectRoot();"/"==n.charAt(0)&&(n=n.substr(0,n.length-1));var o=k.RedirectRoot().split("/"),p="",q=j.$element.attr("data-vm-root");if(null!=q){var r=q.split("/");for(i=0;i<r.length&&(""==r[i]||r[i]!=o[0]);i++)p+=r[i]+"/"}return p+=n+"/"+path,void a(d).attr("href",p).attr("data-vm-route",path).click(function(b){b.preventDefault(),c.router.pushState({},"",a(this).attr("href"))})}if(null==l)throw new Error("vmRoute cannot find any route template at "+d.outerHTML);k.$template=l,j.$router.pathToRoute=j.$router.pathToRoute||{},j.$router.pathToRoute[path]=k,a(d).attr("href",j.$router.toUrl(path)).attr("data-vm-route",path).click(function(b){b.preventDefault(),c.router.pushState({},"",a(this).attr("href"))})}}});